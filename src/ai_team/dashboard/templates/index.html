<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Team Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ========== Reset & Base ========== */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #111827 50%, #0f172a 100%);
            color: #e5e7eb;
            min-height: 100vh;
        }

        /* ========== Top Navigation Bar ========== */
        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            height: 64px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(99, 102, 241, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: #fff;
            letter-spacing: -1px;
        }

        .nav-title {
            font-size: 18px;
            font-weight: 600;
            color: #f9fafb;
            letter-spacing: -0.3px;
        }

        .nav-subtitle {
            font-size: 12px;
            color: #6b7280;
            font-weight: 400;
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #9ca3af;
        }

        .ws-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .ws-status.connected {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }

        .ws-status.disconnected {
            background: #f43f5e;
            box-shadow: 0 0 8px rgba(244, 63, 94, 0.4);
        }

        /* ========== Main Content Layout ========== */
        .main-content {
            padding: 28px 32px 48px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* ========== Section Styles ========== */
        .section {
            margin-bottom: 32px;
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
        }

        .section:nth-child(1) { animation-delay: 0.05s; }
        .section:nth-child(2) { animation-delay: 0.1s; }
        .section:nth-child(3) { animation-delay: 0.15s; }
        .section:nth-child(4) { animation-delay: 0.2s; }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .section-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: #f9fafb;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .section-header .section-icon {
            font-size: 18px;
        }

        .section-header .section-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, rgba(99, 102, 241, 0.3), transparent);
        }

        /* ========== Glassmorphism Cards ========== */
        .glass-card {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 12px;
            transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            border-color: rgba(99, 102, 241, 0.4);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.08);
        }

        /* ========== Agent Cards Grid ========== */
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .agent-card {
            padding: 20px;
        }

        .agent-card-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .agent-identity {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-emoji {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .agent-name {
            font-size: 15px;
            font-weight: 600;
            color: #f9fafb;
            margin-bottom: 2px;
        }

        .agent-role {
            font-size: 12px;
            color: #6b7280;
            font-weight: 400;
        }

        /* Status badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-idle {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }
        .status-idle .status-dot { background: #10b981; box-shadow: 0 0 6px rgba(16, 185, 129, 0.5); }

        .status-working {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }
        .status-working .status-dot { background: #6366f1; box-shadow: 0 0 6px rgba(99, 102, 241, 0.5); }

        .status-blocked {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }
        .status-blocked .status-dot { background: #f59e0b; box-shadow: 0 0 6px rgba(245, 158, 11, 0.5); }

        .status-stopped {
            background: rgba(244, 63, 94, 0.15);
            color: #fb7185;
        }
        .status-stopped .status-dot { background: #f43f5e; box-shadow: 0 0 6px rgba(244, 63, 94, 0.4); }

        .status-error {
            background: rgba(244, 63, 94, 0.15);
            color: #fb7185;
        }
        .status-error .status-dot { background: #f43f5e; }

        /* Agent control buttons */
        .agent-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 14px;
            border: 1px solid rgba(75, 85, 99, 0.4);
            border-radius: 8px;
            background: rgba(31, 41, 55, 0.6);
            color: #9ca3af;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            font-family: 'Inter', sans-serif;
        }

        .btn:hover {
            background: rgba(55, 65, 81, 0.8);
            color: #e5e7eb;
        }

        .btn-chat {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: #fff;
            font-weight: 600;
            padding: 6px 18px;
        }

        .btn-chat:hover {
            background: linear-gradient(135deg, #7c7ff7, #9d78f8);
            color: #fff;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-pause {
            border-color: rgba(245, 158, 11, 0.4);
            color: #fbbf24;
        }
        .btn-pause:hover {
            background: rgba(245, 158, 11, 0.15);
            border-color: #f59e0b;
        }

        .btn-resume {
            border-color: rgba(16, 185, 129, 0.4);
            color: #34d399;
        }
        .btn-resume:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: #10b981;
        }

        .btn-kill {
            border-color: rgba(244, 63, 94, 0.4);
            color: #fb7185;
        }
        .btn-kill:hover {
            background: rgba(244, 63, 94, 0.15);
            border-color: #f43f5e;
        }

        /* ========== Kanban Board ========== */
        .kanban-board {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .kanban-board::-webkit-scrollbar {
            height: 6px;
        }
        .kanban-board::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.3);
            border-radius: 3px;
        }
        .kanban-board::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.5);
            border-radius: 3px;
        }

        .kanban-column {
            min-width: 230px;
            flex: 1;
            background: rgba(17, 24, 39, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(75, 85, 99, 0.25);
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
        }

        .kanban-column-header {
            padding: 14px 16px 10px;
            border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        }

        .kanban-column-header h3 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kanban-column-header .accent-bar {
            width: 3px;
            height: 14px;
            border-radius: 2px;
        }

        .accent-pending    { background: #6366f1; }
        .accent-in_progress { background: #3b82f6; }
        .accent-review     { background: #f59e0b; }
        .accent-completed  { background: #10b981; }
        .accent-failed     { background: #f43f5e; }

        .kanban-column-header .count {
            background: rgba(75, 85, 99, 0.3);
            padding: 1px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            margin-left: auto;
        }

        .column-tasks {
            padding: 10px 12px 12px;
        }

        .task-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(75, 85, 99, 0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .task-card:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .task-card .task-type {
            color: #818cf8;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .task-card .task-meta {
            color: #6b7280;
            font-size: 11px;
        }

        /* ========== Pipeline Runs ========== */
        .runs-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 14px;
        }

        .run-card {
            padding: 18px;
        }

        .run-card .run-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .run-card .run-pipeline {
            color: #f9fafb;
            font-size: 14px;
            font-weight: 600;
        }

        .run-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .run-status-running {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .run-status-awaiting_approval {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .run-status-completed {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .run-status-failed {
            background: rgba(244, 63, 94, 0.15);
            color: #fb7185;
        }

        .run-card .run-id {
            color: #6b7280;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .run-card .run-step {
            color: #9ca3af;
            font-size: 12px;
        }

        .run-progress {
            width: 100%;
            height: 3px;
            background: rgba(75, 85, 99, 0.3);
            border-radius: 2px;
            margin-top: 12px;
            overflow: hidden;
        }

        .run-progress-bar {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            animation: progressPulse 2s ease-in-out infinite;
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Approve/Reject buttons */
        .run-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-approve {
            border-color: rgba(16, 185, 129, 0.4);
            color: #34d399;
        }
        .btn-approve:hover {
            background: rgba(16, 185, 129, 0.15);
            border-color: #10b981;
        }

        .btn-reject {
            border-color: rgba(244, 63, 94, 0.4);
            color: #fb7185;
        }
        .btn-reject:hover {
            background: rgba(244, 63, 94, 0.15);
            border-color: #f43f5e;
        }

        /* ========== Event Log ========== */
        .log-panel {
            background: rgba(10, 14, 26, 0.7);
            border: 1px solid rgba(75, 85, 99, 0.25);
            border-radius: 12px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            scroll-behavior: smooth;
        }

        .log-panel::-webkit-scrollbar {
            width: 6px;
        }
        .log-panel::-webkit-scrollbar-track {
            background: rgba(31, 41, 55, 0.3);
            border-radius: 3px;
        }
        .log-panel::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.5);
            border-radius: 3px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(55, 65, 81, 0.3);
            word-break: break-all;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }

        .log-entry .log-time {
            color: #6b7280;
            margin-right: 10px;
        }

        .log-entry .log-type {
            color: #a78bfa;
            font-weight: 600;
            margin-right: 10px;
        }

        .log-entry .log-body {
            color: #9ca3af;
        }

        /* ========== Empty States ========== */
        .empty-state {
            color: #4b5563;
            font-size: 13px;
            padding: 20px 0;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .empty-state-icon {
            font-size: 18px;
            opacity: 0.5;
        }

        /* ========== Chat Panel ========== */
        .chat-panel {
            position: fixed;
            bottom: 20px;
            width: 420px;
            height: 580px;
            background: rgba(17, 24, 39, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(99, 102, 241, 0.1);
            transition: height 0.25s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }

        .chat-panel.minimized {
            height: 52px;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: linear-gradient(135deg, #6366f1, #7c3aed);
            cursor: pointer;
            flex-shrink: 0;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-emoji {
            font-size: 20px;
        }

        .chat-header .chat-agent-name {
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            line-height: 1.2;
        }

        .chat-header .chat-agent-role {
            color: rgba(255, 255, 255, 0.7);
            font-size: 11px;
            font-weight: 400;
        }

        .chat-header .chat-header-btns {
            display: flex;
            gap: 4px;
        }

        .chat-header .chat-header-btns button {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: rgba(255, 255, 255, 0.85);
            cursor: pointer;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            line-height: 1;
            transition: background 0.15s ease;
        }

        .chat-header .chat-header-btns button:hover {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(75, 85, 99, 0.4);
            border-radius: 2px;
        }

        .chat-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 14px;
            font-size: 13px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .chat-msg.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #6366f1, #7c3aed);
            color: #fff;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
            white-space: pre-wrap;
        }

        .chat-msg.assistant {
            align-self: flex-start;
            background: rgba(31, 41, 55, 0.8);
            color: #e5e7eb;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .chat-msg.system {
            align-self: center;
            background: none;
            color: #6b7280;
            font-style: italic;
            font-size: 12px;
            text-align: center;
            padding: 4px 0;
        }

        .chat-msg.streaming {
            border: 1px solid rgba(99, 102, 241, 0.4);
            position: relative;
        }

        .chat-msg.streaming::after {
            content: '';
            display: inline-block;
            width: 6px;
            height: 14px;
            background: #818cf8;
            margin-left: 2px;
            vertical-align: text-bottom;
            animation: cursorBlink 1s step-end infinite;
        }

        @keyframes cursorBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        /* Typing indicator */
        .typing-indicator {
            align-self: flex-start;
            display: flex;
            gap: 4px;
            padding: 12px 18px;
            background: rgba(31, 41, 55, 0.8);
            border-radius: 14px;
            border-bottom-left-radius: 4px;
        }

        .typing-indicator span {
            width: 6px;
            height: 6px;
            background: #6b7280;
            border-radius: 50%;
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        /* Markdown inside assistant chat bubbles */
        .chat-msg.assistant p { margin-bottom: 8px; }
        .chat-msg.assistant p:last-child { margin-bottom: 0; }

        .chat-msg.assistant h1,
        .chat-msg.assistant h2,
        .chat-msg.assistant h3,
        .chat-msg.assistant h4 {
            color: #f9fafb;
            margin: 12px 0 6px;
            line-height: 1.3;
        }
        .chat-msg.assistant h1 { font-size: 18px; }
        .chat-msg.assistant h2 { font-size: 16px; }
        .chat-msg.assistant h3 { font-size: 14px; }
        .chat-msg.assistant h4 { font-size: 13px; }

        .chat-msg.assistant strong { color: #f9fafb; }

        .chat-msg.assistant a {
            color: #818cf8;
            text-decoration: underline;
            text-decoration-color: rgba(129, 140, 248, 0.4);
        }
        .chat-msg.assistant a:hover {
            color: #a5b4fc;
            text-decoration-color: rgba(129, 140, 248, 0.8);
        }

        .chat-msg.assistant ul,
        .chat-msg.assistant ol {
            margin: 6px 0;
            padding-left: 20px;
        }

        .chat-msg.assistant li {
            margin-bottom: 4px;
        }

        .chat-msg.assistant code {
            background: rgba(99, 102, 241, 0.15);
            color: #c4b5fd;
            padding: 1px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 12px;
        }

        .chat-msg.assistant pre {
            background: rgba(10, 14, 26, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
        }

        .chat-msg.assistant pre code {
            background: none;
            color: #e5e7eb;
            padding: 0;
            font-size: 12px;
            line-height: 1.5;
        }

        .chat-msg.assistant blockquote {
            border-left: 3px solid #6366f1;
            padding-left: 12px;
            margin: 8px 0;
            color: #9ca3af;
        }

        .chat-msg.assistant hr {
            border: none;
            border-top: 1px solid rgba(75, 85, 99, 0.3);
            margin: 10px 0;
        }

        .chat-msg.assistant table {
            border-collapse: collapse;
            margin: 8px 0;
            font-size: 12px;
        }

        .chat-msg.assistant th,
        .chat-msg.assistant td {
            border: 1px solid rgba(75, 85, 99, 0.3);
            padding: 4px 8px;
        }

        .chat-msg.assistant th {
            background: rgba(55, 65, 81, 0.3);
            color: #f9fafb;
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid rgba(75, 85, 99, 0.25);
            flex-shrink: 0;
            background: rgba(15, 23, 42, 0.5);
        }

        .chat-input-area input {
            flex: 1;
            background: rgba(31, 41, 55, 0.6);
            border: 1px solid rgba(75, 85, 99, 0.3);
            border-radius: 12px;
            padding: 10px 16px;
            color: #e5e7eb;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color 0.15s ease;
        }

        .chat-input-area input:focus {
            border-color: rgba(99, 102, 241, 0.5);
        }

        .chat-input-area input:disabled {
            opacity: 0.4;
        }

        .chat-input-area input::placeholder {
            color: #4b5563;
        }

        .chat-input-area button {
            background: linear-gradient(135deg, #6366f1, #7c3aed);
            border: none;
            border-radius: 12px;
            color: #fff;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: opacity 0.15s ease, box-shadow 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
        }

        .chat-input-area button:hover {
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .chat-input-area button:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }

        /* ========== Collapsible Log Toggle ========== */
        .log-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
        }

        .log-toggle-arrow {
            font-size: 12px;
            transition: transform 0.2s ease;
            color: #6b7280;
        }

        .log-toggle-arrow.collapsed {
            transform: rotate(-90deg);
        }

        .log-panel.collapsed {
            max-height: 0;
            padding: 0 16px;
            overflow: hidden;
            border: none;
        }

        /* ========== Pulse animation for streaming ========== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .streaming-pulse {
            animation: pulse 2s ease-in-out infinite;
        }

        /* ========== Responsive ========== */
        @media (max-width: 768px) {
            .main-content { padding: 16px; }
            .top-nav { padding: 0 16px; }
            .agents-grid { grid-template-columns: 1fr; }
            .kanban-board { flex-direction: column; }
            .kanban-column { min-width: 100%; }
            .runs-list { grid-template-columns: 1fr; }
            .chat-panel { width: calc(100vw - 40px); }
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-brand">
            <div class="nav-logo">AI</div>
            <div>
                <div class="nav-title">AI Team Dashboard</div>
                <div class="nav-subtitle">Orchestration & Monitoring</div>
            </div>
        </div>
        <div class="nav-status">
            <span id="wsIndicator" class="ws-status disconnected" title="WebSocket disconnected"></span>
            <span id="wsLabel">Disconnected</span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Agents Section -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">&#x1F916;</span>
                <h2>Agents</h2>
                <div class="section-line"></div>
            </div>
            <div class="agents-grid" id="agentsGrid">
                <div class="empty-state"><span class="empty-state-icon">&#x1F4AD;</span> No agents spawned yet.</div>
            </div>
        </div>

        <!-- Kanban Task Board -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">&#x1F4CB;</span>
                <h2>Task Board</h2>
                <div class="section-line"></div>
            </div>
            <div class="kanban-board" id="kanbanBoard">
                <div class="kanban-column" id="col-pending">
                    <div class="kanban-column-header">
                        <h3><span class="accent-bar accent-pending"></span> Pending <span class="count">0</span></h3>
                    </div>
                    <div class="column-tasks"></div>
                </div>
                <div class="kanban-column" id="col-in_progress">
                    <div class="kanban-column-header">
                        <h3><span class="accent-bar accent-in_progress"></span> In Progress <span class="count">0</span></h3>
                    </div>
                    <div class="column-tasks"></div>
                </div>
                <div class="kanban-column" id="col-review">
                    <div class="kanban-column-header">
                        <h3><span class="accent-bar accent-review"></span> Review <span class="count">0</span></h3>
                    </div>
                    <div class="column-tasks"></div>
                </div>
                <div class="kanban-column" id="col-completed">
                    <div class="kanban-column-header">
                        <h3><span class="accent-bar accent-completed"></span> Completed <span class="count">0</span></h3>
                    </div>
                    <div class="column-tasks"></div>
                </div>
                <div class="kanban-column" id="col-failed">
                    <div class="kanban-column-header">
                        <h3><span class="accent-bar accent-failed"></span> Failed <span class="count">0</span></h3>
                    </div>
                    <div class="column-tasks"></div>
                </div>
            </div>
        </div>

        <!-- Pipeline Runs -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">&#x1F680;</span>
                <h2>Pipeline Runs</h2>
                <div class="section-line"></div>
            </div>
            <div class="runs-list" id="runsList">
                <div class="empty-state"><span class="empty-state-icon">&#x26A1;</span> No active pipeline runs.</div>
            </div>
        </div>

        <!-- Real-time Event Log -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">&#x1F4DC;</span>
                <h2 class="log-toggle" onclick="toggleLogPanel()">
                    Event Log
                    <span class="log-toggle-arrow" id="logArrow">&#x25BC;</span>
                </h2>
                <div class="section-line"></div>
            </div>
            <div class="log-panel" id="logPanel">
                <div class="empty-state"><span class="empty-state-icon">&#x23F3;</span> Waiting for events...</div>
            </div>
        </div>
    </div>

    <script>
        // --- Configure marked.js ---
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // --- Agent display metadata ---
        const AGENT_DISPLAY = {
            pm:         { emoji: '\uD83D\uDCCB', title: 'Project Manager' },
            researcher: { emoji: '\uD83D\uDD0D', title: 'Researcher' },
            architect:  { emoji: '\uD83C\uDFD7\uFE0F', title: 'Architect' },
            coder:      { emoji: '\uD83D\uDCBB', title: 'Coder' },
            tester:     { emoji: '\uD83E\uDDEA', title: 'Tester' },
            reviewer:   { emoji: '\uD83D\uDC41\uFE0F', title: 'Code Reviewer' }
        };

        function getAgentDisplay(name) {
            const key = name.toLowerCase().replace(/[^a-z]/g, '');
            if (AGENT_DISPLAY[key]) return AGENT_DISPLAY[key];
            // Try to match partial names
            for (const [k, v] of Object.entries(AGENT_DISPLAY)) {
                if (key.includes(k) || k.includes(key)) return v;
            }
            return { emoji: '\uD83E\uDD16', title: 'Agent' };
        }

        // --- State ---
        let ws = null;
        let reconnectTimer = null;
        const MAX_LOG_ENTRIES = 200;

        // --- Log panel collapse ---
        function toggleLogPanel() {
            const panel = document.getElementById('logPanel');
            const arrow = document.getElementById('logArrow');
            panel.classList.toggle('collapsed');
            arrow.classList.toggle('collapsed');
        }

        // --- WebSocket ---
        function connectWebSocket() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/ws`);

            ws.onopen = () => {
                document.getElementById('wsIndicator').className = 'ws-status connected';
                document.getElementById('wsIndicator').title = 'WebSocket connected';
                document.getElementById('wsLabel').textContent = 'Connected';
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
                // Initial data load
                refreshAll();
            };

            ws.onmessage = (e) => {
                const event = JSON.parse(e.data);
                appendLog(event);
                // Refresh relevant sections based on event type
                if (event.type && (event.type.includes('agent') || event.type.includes('team'))) {
                    refreshAgents();
                }
                if (event.type && (event.type.includes('task') || event.type.includes('pipeline'))) {
                    refreshTaskBoard();
                    refreshRuns();
                }
                if (event.type && event.type.includes('checkpoint')) {
                    refreshRuns();
                }
            };

            ws.onclose = () => {
                document.getElementById('wsIndicator').className = 'ws-status disconnected';
                document.getElementById('wsIndicator').title = 'WebSocket disconnected - reconnecting...';
                document.getElementById('wsLabel').textContent = 'Disconnected';
                reconnectTimer = setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = () => {
                ws.close();
            };
        }

        // --- Log Stream ---
        function appendLog(event) {
            const logPanel = document.getElementById('logPanel');
            // Remove empty state if present
            const emptyState = logPanel.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const entry = document.createElement('div');
            entry.className = 'log-entry';

            const time = new Date().toLocaleTimeString();
            const type = event.type || 'unknown';
            const body = JSON.stringify(event, null, 0);

            entry.innerHTML =
                '<span class="log-time">' + escapeHtml(time) + '</span>' +
                '<span class="log-type">' + escapeHtml(type) + '</span>' +
                '<span class="log-body">' + escapeHtml(body) + '</span>';

            logPanel.prepend(entry);

            // Trim old entries
            const entries = logPanel.querySelectorAll('.log-entry');
            if (entries.length > MAX_LOG_ENTRIES) {
                for (let i = MAX_LOG_ENTRIES; i < entries.length; i++) {
                    entries[i].remove();
                }
            }
        }

        // --- Agents ---
        async function refreshAgents() {
            try {
                const resp = await fetch('/api/team');
                const team = await resp.json();
                const grid = document.getElementById('agentsGrid');

                if (Object.keys(team).length === 0) {
                    grid.innerHTML = '<div class="empty-state"><span class="empty-state-icon">&#x1F4AD;</span> No agents spawned yet.</div>';
                    return;
                }

                grid.innerHTML = '';
                for (const [name, status] of Object.entries(team)) {
                    const display = getAgentDisplay(name);
                    const card = document.createElement('div');
                    card.className = 'agent-card glass-card';
                    card.innerHTML =
                        '<div class="agent-card-top">' +
                            '<div class="agent-identity">' +
                                '<div class="agent-emoji">' + display.emoji + '</div>' +
                                '<div>' +
                                    '<div class="agent-name">' + escapeHtml(name) + '</div>' +
                                    '<div class="agent-role">' + escapeHtml(display.title) + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<span class="status-badge status-' + escapeHtml(status) + '">' +
                                '<span class="status-dot"></span>' +
                                escapeHtml(status) +
                            '</span>' +
                        '</div>' +
                        '<div class="agent-controls">' +
                            '<button class="btn btn-chat" onclick="openChat(\'' + escapeHtml(name) + '\')">&#x1F4AC; Chat</button>' +
                            '<button class="btn btn-pause" onclick="agentAction(\'' + escapeHtml(name) + '\', \'pause\')">Pause</button>' +
                            '<button class="btn btn-resume" onclick="agentAction(\'' + escapeHtml(name) + '\', \'resume\')">Resume</button>' +
                            '<button class="btn btn-kill" onclick="agentAction(\'' + escapeHtml(name) + '\', \'kill\')">Kill</button>' +
                        '</div>';
                    grid.appendChild(card);
                }
            } catch (err) {
                console.error('Failed to refresh agents:', err);
            }
        }

        async function agentAction(name, action) {
            try {
                const resp = await fetch('/api/agents/' + encodeURIComponent(name) + '/' + action, { method: 'POST' });
                if (resp.ok) {
                    refreshAgents();
                }
            } catch (err) {
                console.error('Agent action failed:', err);
            }
        }

        // --- Kanban Task Board ---
        async function refreshTaskBoard() {
            try {
                const resp = await fetch('/api/tasks/board');
                const board = await resp.json();

                const columns = ['pending', 'in_progress', 'review', 'completed', 'failed'];
                for (const col of columns) {
                    const colEl = document.getElementById('col-' + col);
                    if (!colEl) continue;

                    const tasks = board[col] || [];
                    const countEl = colEl.querySelector('.count');
                    if (countEl) countEl.textContent = tasks.length;

                    const tasksContainer = colEl.querySelector('.column-tasks');
                    tasksContainer.innerHTML = '';

                    for (const task of tasks) {
                        const card = document.createElement('div');
                        card.className = 'task-card';
                        card.innerHTML =
                            '<div class="task-type">' + escapeHtml(task.task_type || 'task') + '</div>' +
                            '<div class="task-meta">' +
                                'ID: ' + escapeHtml(String(task.id || '')) +
                                (task.assigned_to ? ' | Agent: ' + escapeHtml(task.assigned_to) : '') +
                                (task.pipeline_id ? ' | Pipeline: ' + escapeHtml(task.pipeline_id) : '') +
                            '</div>';
                        tasksContainer.appendChild(card);
                    }

                    if (tasks.length === 0) {
                        tasksContainer.innerHTML = '<div class="empty-state"><span class="empty-state-icon">&#x1F4E6;</span> No tasks</div>';
                    }
                }
            } catch (err) {
                console.error('Failed to refresh task board:', err);
            }
        }

        // --- Pipeline Runs ---
        async function refreshRuns() {
            try {
                const resp = await fetch('/api/runs');
                const runs = await resp.json();
                const runsList = document.getElementById('runsList');

                if (runs.length === 0) {
                    runsList.innerHTML = '<div class="empty-state"><span class="empty-state-icon">&#x26A1;</span> No active pipeline runs.</div>';
                    return;
                }

                runsList.innerHTML = '';
                for (const run of runs) {
                    const card = document.createElement('div');
                    card.className = 'run-card glass-card';

                    let statusClass = 'run-status-' + (run.status || 'running');
                    let actionsHtml = '';
                    if (run.status === 'awaiting_approval') {
                        actionsHtml =
                            '<div class="run-actions">' +
                                '<button class="btn btn-approve" onclick="approveRun(\'' + escapeHtml(run.run_id) + '\')">&#x2705; Approve</button>' +
                                '<button class="btn btn-reject" onclick="rejectRun(\'' + escapeHtml(run.run_id) + '\')">&#x274C; Reject</button>' +
                            '</div>';
                    }

                    let progressHtml = '';
                    if (run.status === 'running') {
                        progressHtml = '<div class="run-progress"><div class="run-progress-bar" style="width: 60%;"></div></div>';
                    }

                    card.innerHTML =
                        '<div class="run-header">' +
                            '<span class="run-pipeline">' + escapeHtml(run.pipeline || '') + '</span>' +
                            '<span class="run-status ' + statusClass + '">' + escapeHtml(run.status || '') + '</span>' +
                        '</div>' +
                        '<div class="run-id">Run: ' + escapeHtml(run.run_id || '') + '</div>' +
                        '<div class="run-step">Step: ' + (run.current_step != null ? run.current_step : '?') + '</div>' +
                        progressHtml +
                        actionsHtml;

                    runsList.appendChild(card);
                }
            } catch (err) {
                console.error('Failed to refresh runs:', err);
            }
        }

        async function approveRun(runId) {
            try {
                await fetch('/api/runs/' + encodeURIComponent(runId) + '/approve', { method: 'POST' });
                refreshRuns();
            } catch (err) {
                console.error('Approve failed:', err);
            }
        }

        async function rejectRun(runId) {
            try {
                await fetch('/api/runs/' + encodeURIComponent(runId) + '/reject', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason: 'Rejected from dashboard' })
                });
                refreshRuns();
            } catch (err) {
                console.error('Reject failed:', err);
            }
        }

        // --- Utilities ---
        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function refreshAll() {
            refreshAgents();
            refreshTaskBoard();
            refreshRuns();
        }

        // --- Chat System ---
        const chatPanels = {};  // agent_name -> { ws, panelEl, messagesEl, inputEl, sendBtn, streamingEl }
        let chatPanelCount = 0;

        function openChat(agentName) {
            // If already open, focus it
            if (chatPanels[agentName]) {
                chatPanels[agentName].panelEl.classList.remove('minimized');
                chatPanels[agentName].inputEl.focus();
                return;
            }

            const display = getAgentDisplay(agentName);

            // Create panel element
            const panel = document.createElement('div');
            panel.className = 'chat-panel';
            panel.style.right = (20 + chatPanelCount * 440) + 'px';
            panel.id = 'chat-panel-' + agentName;

            panel.innerHTML =
                '<div class="chat-header" onclick="minimizeChat(\'' + escapeHtml(agentName) + '\')">' +
                    '<div class="chat-header-info">' +
                        '<span class="chat-header-emoji">' + display.emoji + '</span>' +
                        '<div>' +
                            '<div class="chat-agent-name">' + escapeHtml(agentName) + '</div>' +
                            '<div class="chat-agent-role">' + escapeHtml(display.title) + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="chat-header-btns">' +
                        '<button onclick="event.stopPropagation(); minimizeChat(\'' + escapeHtml(agentName) + '\')" title="Minimize">&minus;</button>' +
                        '<button onclick="event.stopPropagation(); closeChat(\'' + escapeHtml(agentName) + '\')" title="Close">&times;</button>' +
                    '</div>' +
                '</div>' +
                '<div class="chat-messages" id="chat-messages-' + agentName + '"></div>' +
                '<div class="chat-input-area">' +
                    '<input type="text" id="chat-input-' + agentName + '" placeholder="Type a message..." ' +
                        'onkeydown="if(event.key===\'Enter\')sendChatMessage(\'' + escapeHtml(agentName) + '\')" disabled />' +
                    '<button id="chat-send-' + agentName + '" onclick="sendChatMessage(\'' + escapeHtml(agentName) + '\')" disabled>' +
                        '&#x27A4;' +
                    '</button>' +
                '</div>';

            document.body.appendChild(panel);

            const messagesEl = document.getElementById('chat-messages-' + agentName);
            const inputEl = document.getElementById('chat-input-' + agentName);
            const sendBtn = document.getElementById('chat-send-' + agentName);

            // Connect WebSocket
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const chatWs = new WebSocket(`${protocol}//${location.host}/ws/chat/${encodeURIComponent(agentName)}`);

            chatPanels[agentName] = {
                ws: chatWs,
                panelEl: panel,
                messagesEl: messagesEl,
                inputEl: inputEl,
                sendBtn: sendBtn,
                streamingEl: null
            };

            chatPanelCount++;

            appendChatBubble(agentName, 'system', 'Connecting...');

            chatWs.onopen = () => {
                chatWs.send(JSON.stringify({ type: 'start_session' }));
            };

            chatWs.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                handleChatMessage(agentName, msg);
            };

            chatWs.onclose = () => {
                appendChatBubble(agentName, 'system', 'Disconnected.');
                inputEl.disabled = true;
                sendBtn.disabled = true;
            };

            chatWs.onerror = () => {
                appendChatBubble(agentName, 'system', 'Connection error.');
            };
        }

        function handleChatMessage(agentName, msg) {
            const chat = chatPanels[agentName];
            if (!chat) return;

            switch (msg.type) {
                case 'session_started':
                    appendChatBubble(agentName, 'system', 'Connected to ' + agentName + '.');
                    chat.inputEl.disabled = false;
                    chat.sendBtn.disabled = false;
                    chat.inputEl.focus();
                    break;

                case 'chat_token':
                    // Streaming token -- append to existing streaming bubble or create one
                    if (!chat.streamingEl) {
                        chat.streamingEl = document.createElement('div');
                        chat.streamingEl.className = 'chat-msg assistant streaming';
                        chat.streamingEl.setAttribute('data-raw', '');
                        chat.messagesEl.appendChild(chat.streamingEl);
                    }
                    // Accumulate raw text in data attribute
                    const rawSoFar = chat.streamingEl.getAttribute('data-raw') + msg.content;
                    chat.streamingEl.setAttribute('data-raw', rawSoFar);
                    // Re-render full accumulated text with marked
                    chat.streamingEl.innerHTML = marked.parse(rawSoFar);
                    chat.messagesEl.scrollTop = chat.messagesEl.scrollHeight;
                    break;

                case 'chat_tool_use':
                    appendChatBubble(agentName, 'system', 'Using tool: ' + (msg.tool || 'unknown'));
                    break;

                case 'chat_response_complete':
                    // Finalize streaming bubble
                    if (chat.streamingEl) {
                        chat.streamingEl.classList.remove('streaming');
                        // Final render with complete content
                        const finalRaw = chat.streamingEl.getAttribute('data-raw') || '';
                        if (finalRaw) {
                            chat.streamingEl.innerHTML = marked.parse(finalRaw);
                        }
                        chat.streamingEl = null;
                    }
                    chat.inputEl.disabled = false;
                    chat.sendBtn.disabled = false;
                    chat.inputEl.focus();
                    break;

                case 'chat_error':
                    appendChatBubble(agentName, 'system', 'Error: ' + (msg.error || 'Unknown error'));
                    chat.inputEl.disabled = false;
                    chat.sendBtn.disabled = false;
                    break;

                case 'session_stopped':
                    appendChatBubble(agentName, 'system', 'Session ended.');
                    break;
            }
        }

        function sendChatMessage(agentName) {
            const chat = chatPanels[agentName];
            if (!chat || !chat.ws) return;

            const text = chat.inputEl.value.trim();
            if (!text) return;

            // Show user message
            appendChatBubble(agentName, 'user', text);
            chat.inputEl.value = '';

            // Disable input while waiting
            chat.inputEl.disabled = true;
            chat.sendBtn.disabled = true;

            // Send to server
            chat.ws.send(JSON.stringify({ type: 'chat_message', content: text }));
        }

        function closeChat(agentName) {
            const chat = chatPanels[agentName];
            if (!chat) return;

            // Send stop_session if connected
            if (chat.ws && chat.ws.readyState === WebSocket.OPEN) {
                chat.ws.send(JSON.stringify({ type: 'stop_session' }));
            }
            chat.ws.close();

            // Remove panel from DOM
            chat.panelEl.remove();
            delete chatPanels[agentName];
            chatPanelCount = Math.max(0, chatPanelCount - 1);
        }

        function minimizeChat(agentName) {
            const chat = chatPanels[agentName];
            if (!chat) return;
            chat.panelEl.classList.toggle('minimized');
        }

        function appendChatBubble(agentName, role, text) {
            const chat = chatPanels[agentName];
            if (!chat) return;

            const bubble = document.createElement('div');
            bubble.className = 'chat-msg ' + role;

            if (role === 'assistant') {
                // Render markdown for assistant messages
                bubble.innerHTML = marked.parse(text);
            } else {
                bubble.textContent = text;
            }

            chat.messagesEl.appendChild(bubble);
            chat.messagesEl.scrollTop = chat.messagesEl.scrollHeight;
        }

        // --- Init ---
        connectWebSocket();
    </script>
</body>
</html>
